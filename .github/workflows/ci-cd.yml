name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  DOCKER_IMAGE: wecarmobility/blh-homepage
  DOCKER_REGISTRY: docker.io

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run basic tests
      run: |
        python -c "import app; print('App imports successfully')"

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Generate tags
      id: meta
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
        echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
        echo "tags=${DOCKER_IMAGE}:latest,${DOCKER_IMAGE}:${TIMESTAMP},${DOCKER_IMAGE}:${SHORT_SHA}" >> $GITHUB_OUTPUT

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Update deployment info
      run: |
        echo "ğŸš€ Docker image pushed successfully!" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“¦ Tags: ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ”— Docker Hub: https://hub.docker.com/r/${{ env.DOCKER_IMAGE }}" >> $GITHUB_STEP_SUMMARY

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create deployment script
      run: |
        cat > deploy-latest.sh << 'EOF'
        #!/bin/bash
        
        # BLH Homepage ìë™ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
        set -e
        
        echo "ğŸš€ BLH Homepage ë°°í¬ ì‹œì‘..."
        
        # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
        if docker ps -q --filter "name=blh-homepage-container" | grep -q .; then
            echo "â¹ï¸  ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
            docker stop blh-homepage-container
            docker rm blh-homepage-container
        fi
        
        # ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
        echo "ğŸ“¥ ìµœì‹  Docker ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
        docker pull ${{ env.DOCKER_IMAGE }}:latest
        
        # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        echo "ğŸ”„ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
        docker run -d \
          --name blh-homepage-container \
          -p 3001:3001 \
          --restart unless-stopped \
          --health-cmd="curl -f http://localhost:3001/health || exit 1" \
          --health-interval=30s \
          --health-timeout=10s \
          --health-retries=3 \
          ${{ env.DOCKER_IMAGE }}:latest
        
        # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
        echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
        sleep 10
        
        # ë°°í¬ í™•ì¸
        if curl -f http://localhost:3001/health > /dev/null 2>&1; then
            echo "âœ… ë°°í¬ ì„±ê³µ! ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
            echo "ğŸŒ ì ‘ì† URL: http://localhost:3001"
        else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨! í—¬ìŠ¤ì²´í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
            docker logs blh-homepage-container
            exit 1
        fi
        
        # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
        echo "ğŸ§¹ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
        docker image prune -f
        
        echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
        EOF
        
        chmod +x deploy-latest.sh

    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v3
      with:
        name: deployment-scripts
        path: |
          deploy-latest.sh
          docker-compose.yml
          Dockerfile

    - name: Create release info
      run: |
        echo "## ğŸš€ ìë™ ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ ë°°í¬ ì •ë³´" >> $GITHUB_STEP_SUMMARY
        echo "- **ì»¤ë°‹**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¸Œëœì¹˜**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ì‹œê°„**: \`$(date -u)\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ³ Docker ì´ë¯¸ì§€" >> $GITHUB_STEP_SUMMARY
        echo "- **ë ˆì§€ìŠ¤íŠ¸ë¦¬**: \`${{ env.DOCKER_IMAGE }}:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ë§í¬**: [Docker Hub](https://hub.docker.com/r/${{ env.DOCKER_IMAGE }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸" >> $GITHUB_STEP_SUMMARY
        echo "ë‹¤ìš´ë¡œë“œí•œ \`deploy-latest.sh\` ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ ìµœì‹  ë²„ì „ì„ ë°°í¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "./deploy-latest.sh" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  notify:
    needs: [build-and-push, deploy]
    runs-on: ubuntu-latest
    if: always() && (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'))
    
    steps:
    - name: Notify deployment status
      run: |
        if [[ "${{ needs.build-and-push.result }}" == "success" && "${{ needs.deploy.result }}" == "success" ]]; then
          echo "âœ… ë°°í¬ ì„±ê³µ: ëª¨ë“  ë‹¨ê³„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
        else
          echo "âŒ ë°°í¬ ì‹¤íŒ¨: ì¼ë¶€ ë‹¨ê³„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
          echo "- Build & Push: ${{ needs.build-and-push.result }}"
          echo "- Deploy: ${{ needs.deploy.result }}"
        fi
